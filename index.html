<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />

    <!-- Styles -->
    <link href="/css/normalize.css" type="text/css" rel="stylesheet" />
    <link href="/css/result-light.css" type="text/css" rel="stylesheet" />
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.no-icons.min.css" type="text/css" rel="stylesheet" />
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" type="text/css" rel="stylesheet" />

    <!-- Scripts -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="bitcoinjs.min.js"></script>
    <script type="text/javascript" src="buffer.js"></script>



    <link href="https://fonts.googleapis.com/css?family=Pacifico" type="text/css" rel="stylesheet" />
    <style type="text/css">
        body {
            margin: 10px;
        }

        .navbar-brand {
            font-family: 'Pacifico', cursive;
            font-style: italic;
            font-size: 46px;
        }

        body {
            padding-top: 60px;
        }

        [hidden] {
            display: none;
        }

        .bitcoin-action-hint {
            display: none;
        }

        .bitcoin-address-container .bitcoin-address {
            border-bottom: 1px dashed gray;
            cursor: pointer;
        }

        .bitcoin-address-qr-container > img, .bitcoin-address-qr-container > canvas {
            margin: 0 auto;
        }

        .clickable-price {
            border-bottom: 1px dashed #888;
            cursor: pointer;
        }

        #bitcoin-icon {
            color: #f7931a;
            font-size: 128px;
        }

            #bitcoin-icon .fa-circle {
                text-shadow: 0 3px 3px rgba(32, 32, 32, 0.3);
            }

            #bitcoin-icon .fa-btc {
                text-shadow: 0 -1px 1px black;
                transform: rotate(20deg);
            }

        .example-row {
            margin: 30px 0;
        }

        .example-heading {
            color: #357ebd;
        }

        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">Glitch Chain</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 col-md-offset-4">
                <p class="text-center">
                    <strong class="bitcoin-address bitcoin-address-display-value" data-bc-address="19356KxTs9Bw5AAdxens5hoxDSp5bsUKse">19356KxTs9Bw5AAdxens5hoxDSp5bsUKse</strong>
                </p>
            </div>

            <div id="bitcoin-address-template" class="bitcoin-address-container" style="display: none">
                <div class="well">
                    <div class="row">
                        <div class="col-md-12">
                            <!-- Price -->
                            <span id="donation-usd" data-usd-amount="0.001"></span>
                            <div id="donation-btc">
                                Send
                                <strong class="clickable-price" data-btc-price="0.0001">
                                    0.0001
                                    <i class="fa fa-btc"></i>
                                </strong>
                                to save your image.
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <!-- Payment -->
                            <span class="bitcoin-address-display-value"></span>

                            <a href="#" class="bitcoin-address-action bitcoin-address-action-send">
                                <i class="fa fa-btc"></i>
                                Pay from wallet
                            </a>

                            <a href="#" class="bitcoin-address-action bitcoin-address-action-copy">
                                <i class="fa fa-copy"></i>
                                Copy
                            </a>

                            <a href="#" class="bitcoin-address-action bitcoin-address-action-qr">
                                <i class="fa fa-qrcode"></i>
                                QR code
                            </a>

                            <div class="bitcoin-action-hint bitcoin-action-hint-send">
                                Sending payment to the address from locally installed Bitcoin wallet app.
                            </div>

                            <div class="bitcoin-action-hint bitcoin-action-hint-copy">
                                Press CTRL + C or &#x2318; + C to copy the Bitcoin address.
                            </div>

                            <div class="bitcoin-action-hint bitcoin-action-hint-qr">
                                <p>
                                    Scan the QR code with your mobile Bitcoin app to
                                    make the payment:
                                </p>

                                <div class="bitcoin-address-qr-container">
                                    <!-- Filled in by JS on action click -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br />
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="webSocketDebug"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!! I dont know how to write Javascript! (I can only read it)

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!! PLEASE SOMEONE ADD SOME ENCASPULATION AND SCOPE !!


        // ------------------- Creating a client side temporary disposable wallet ----------------

        var keyPair = bitcoin.ECPair.makeRandom();

        // Print your private key (in WIF format)
        var temporaryPrivateKey = keyPair.toWIF();
        keyPair.to

        console.log(temporaryPrivateKey);
        // => Kxr9tQED9H44gCmp6HAdmemAzU3n84H3dGkuWTKvE23JgHMW8gct

        

        // Print your public key address
        console.log(keyPair.getAddress());
        // => 14bZ7YWde4KdRb5YN7GYkToz3EHVCvRxkF
        var newPublicAddress = keyPair.getAddress();
        $(".bitcoin-address-display-value").attr("data-bc-address", newPublicAddress);
        $(".bitcoin-address-display-value").html(newPublicAddress);

        // ------------------- Creating a client side temporary disposable wallet ----------------


        // ------------------- Listening for an incoming transaction on that new public address
        // ------------------- and when recieved creating OPCHECK transation.

        var wsUri = "ws://ws.blockchain.info/inv";
        var output;
        function init()
        {
            output = document.getElementById("webSocketDebug");
            testWebSocket();
        }
        function testWebSocket()
        {
            websocket = new WebSocket(wsUri);
            websocket.onopen = function (evt)
            {
                onOpen(evt)
            };
            websocket.onclose = function (evt)
            {
                onClose(evt)
            };
            websocket.onmessage = function (evt)
            {
                onMessage(evt)
            };
            websocket.onerror = function (evt)
            {
                onError(evt)
            };
        }
        function onOpen(evt)
        {
            writeToScreen("CONNECTED");
            doSend('{"op":"addr_sub", "addr":"' + newPublicAddress + '"}');
            //doSend('{"op":"unconfirmed_sub"}');
        }
        function onClose(evt)
        {
            writeToScreen("DISCONNECTED");
        }
        function onMessage(evt)
        {

            // -------------------------------------------------------------
            // Get the data of the unconfirmed transaction

            websocket.close(); // dont need any more messages

            writeToScreen('<span style="color: green;"> ~~ Transaction recieved ~~ </span>');
            writeToScreen('<span style="color: green;">~~~~~~~~~~~~~~~~~~~~~~~~~~~~ </span>');

            var txnIn = JSON.parse(evt.data);
            var transactionHash = txnIn.x.hash;
            console.log('TxnIn HASH :' + transactionHash);

            var totalSatoshisRecieved = txnIn.x.out[0].value;
            console.log('TxnIn SATOSHI :' + totalSatoshisRecieved);

            writeToScreen('TxnIn HASH :' + transactionHash);
            writeToScreen('TxnIn SATOSHI :' + writeToScreen);

            writeToScreen('-------------------------------------------------------------');
            // -------------------------------------------------------------
            // Pass the satoshi onto our main account with OP_RETURN

            var txnOut = new bitcoin.TransactionBuilder();

            // Add the input (who is paying) of the form [previous transaction hash, index of the output to use]
            txnOut.addInput(transactionHash, 0);

            // Add the output (who to pay to) of the form [payee's address, amount in satoshis]
            var listeningPublicAddress = "1KRAPo6pX457sKKBdiXQGuK2RV6ELvnB1x";
            txnOut.addOutput(listeningPublicAddress, totalSatoshisRecieved);
            console.log('TxnOut PublicAddress :' + listeningPublicAddress);

            var opReturn = "Hello World";
            var opReturnData = new Buffer(opReturn);
            //txnOut.addOutput(bitcoin.script.fromChunks(bitcoin.script.opscode.OP_RETURN, opReturnData), 0);
            txnOut.addOutput(bitcoin.script.fromASM('OP_RETURN 4141'), 0);
            console.log('TxnOut OP_RETURN :' + opReturn);


            console.log('Signing with privatekey : ', temporaryPrivateKey);
            console.log('Creating ECKey from privatekey.....');
            var ecKey = bitcoin.ECPair.fromWIF(temporaryPrivateKey);
            console.log('Created!');

            var signedTxn = txnOut.sign(0, ecKey);
            console.log('TxnOut SIGNED SUCCESS');

            var txnOutCompile = txnOut.build();

            var txnOutHex = txnOutCompile.toHex();
            console.log('TxnOut ToHEX :' + txnOutHex);

            writeToScreen('TxnOut PublicAddress :' + listeningPublicAddress);
            writeToScreen('TxnOut OP_RETURN :' + opReturn);
            writeToScreen('TxnOut HEX' + txnOutHex);
        }
        function onError(evt)
        {
            writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
        }
        function doSend(message)
        {
            writeToScreen("SENT: " + message);
            websocket.send(message);
        }
        function writeToScreen(message)
        {
            var pre = document.createElement("p");
            pre.style.wordWrap = "break-word";
            pre.innerHTML = message;
            output.appendChild(pre);
        }
        function hackScriptFromChunks(chunks)
        {
          

            var bufferSize = chunks.reduce(function (accum, chunk) {
                if (Buffer.isBuffer(chunk)) {
                    return accum + bufferutils.pushDataSize(chunk.length) + chunk.length
                }

                return accum + 1
            }, 0.0)

            var buffer = new Buffer(bufferSize)
            var offset = 0

            chunks.forEach(function (chunk) {
                if (Buffer.isBuffer(chunk)) {
                    offset += bufferutils.writePushDataInt(buffer, chunk.length, offset)

                    chunk.copy(buffer, offset)
                    offset += chunk.length

                } else {
                    buffer.writeUInt8(chunk, offset)
                    offset += 1
                }
            })

            assert.equal(offset, buffer.length, 'Could not decode chunks')
            return new bitcoin.script(buffer, chunks)
            
        }

        window.addEventListener("load", init, false);
    </script>
    <!-- The BITCOINADDRESS.JS DEMO has been completely ripped. Too large to include in the static file. -->
    <!-- The script above - generating the private and public key, must be run first to modify the public key hashes in DOM -->
    <script type="text/javascript" src="//rawgithub.com/miohtama/bitcoinaddress.js/master/dist/demo.js"></script>
</body>
</html>