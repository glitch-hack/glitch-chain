<html>
	<head>
		<title> glitch-chain client </title>
			<script type="text/javascript" src="js/buffer.js"></script>
    		<script type="text/javascript" src="js/bitcoinjs.min.js"></script>
			<script src="lib/glitch-canvas.js"> </script>

			<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>

	<body>
		<div id="main-wrapper">
		<h1> Glitch-Client </h1>
			<canvas id="glitch-canvas" style="border:1px solid #000000;"> </canvas>

			<img id="glitch-image" src="images/test.jpg"> </img>

			<div id="toolpanel">
				<ul id="parameter-list">
					<li>
						<p>Amount</p>
						<input id="amountSlider" type="range" min="0" max="100"/>
						<div id="amountValue">50</div>
					</li>

					<li>
						<p>Seed</p>
						<input id="seedSlider" type="range" min="0" max="100"/>
						<div id="seedValue">50</div>
					</li>

					<li>
						<p>Iterations</p>
						<input id="iterationsSlider" type="range" min="0" max="100"/>
						<div id="iterationsValue">50</div>
					</li>

					<li>
						<p>Quality</p>
						<input id="qualitySlider" type="range" min="0" max="100"/>
						<div id="qualityValue">50</div>
					</li>

					<li>
						<div class="verticalButtons" style="margin-top: 29px">
							<button id="randomise-button" class="action-button"> Randomise </button>
						  <button id="glitch-button" class="action-button"> Glitch </button>
						</div>
					</li>
				</ul>
			</div>


		</div>

		</div>

		<script>

    var sourceImage = document.getElementById('glitch-image');
		var targetCanvas = document.getElementById('glitch-canvas');

		function glitchClicked(){
			var amountValue = document.getElementById('amountValue').innerHTML;
			var seedValue = document.getElementById('seedValue').innerHTML;
			var iterationsValue = document.getElementById('iterationsValue').innerHTML;
			var qualityValue = document.getElementById('qualityValue').innerHTML;

			var parameters = {
				amount: amountValue,
				seed: seedValue,
				iterations: iterationsValue,
				quality: qualityValue };

				doGlitch(sourceImage, targetCanvas, parameters);
		}

		function randomiseClicked()
		{
			document.getElementById('amountSlider').value = Math.floor((Math.random() * 100) + 1);
			document.getElementById('seedSlider').value = Math.floor((Math.random() * 100) + 1);
			document.getElementById('iterationsSlider').value = Math.floor((Math.random() * 100) + 1);
			document.getElementById('qualitySlider').value = Math.floor((Math.random() * 100) + 1);

			amountSliderChanged();
			seedSliderChanged();
			iterationsSliderChanged();
			qualitySliderChanged();
		}

		function doGlitch(source, target, parameters) {
			var ctx = targetCanvas.getContext('2d');

			// draw the image on the canvas
			ctx.drawImage(source, 0, 0);
			var imageData = ctx.getImageData(0, 0, target.clientWidth, target.clientHeight);

			function drawGlitchedImageData(image_data) {
		  	ctx.putImageData(image_data, 0, 0);
			}

			glitch(imageData, parameters, drawGlitchedImageData);
		}

		function setOriginalImage(){
			var ctx = targetCanvas.getContext('2d');
			ctx.drawImage(sourceImage, 0, 0);
		}

		function amountSliderChanged() {
				document.getElementById('amountValue').innerHTML = document.getElementById('amountSlider').value;
				glitchClicked();
		}

		function seedSliderChanged() {
				document.getElementById('seedValue').innerHTML = document.getElementById('seedSlider').value;
				glitchClicked();
		}

		function iterationsSliderChanged() {
				document.getElementById('iterationsValue').innerHTML = document.getElementById('iterationsSlider').value;
				glitchClicked();
		}

		function qualitySliderChanged() {
				document.getElementById('qualityValue').innerHTML = document.getElementById('qualitySlider').value;
				glitchClicked();
		}

			window.addEventListener("load", function() {
				 // Get elements
				 var glitchButton = document.getElementById('glitch-button');
				 var randomiseButton = document.getElementById('randomise-button');

				 // Add event listeners
				 amountSlider.addEventListener('input', amountSliderChanged);
				 seedSlider.addEventListener('input', seedSliderChanged);
				 iterationsSlider.addEventListener('input', iterationsSliderChanged);
				 qualitySlider.addEventListener('input', qualitySliderChanged);
				 glitchButton.addEventListener('click', glitchClicked);
				 randomiseButton.addEventListener('click', randomiseClicked);

				 // Call changed event handlers to initialise values
				 amountSliderChanged();
				 seedSliderChanged();
				 iterationsSliderChanged();
				 qualitySliderChanged();

				 setOriginalImage()
			});



        // for testing only




        function rng () {
            return new Buffer('zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz')
        }

        // generate random keyPair
        var keyPair = bitcoin.ECPair.makeRandom({ rng: rng })
        var address = keyPair.getAddress()

        console.log(keyPair, address);

        var getTransactions = function (address, callback) {
            // Fetch transactions from block explorer calling `callback`
            // on response coerced to JSON.
            var request = new XMLHttpRequest();
            request.open(
                "get",
                "https://insight.bitpay.com/api/txs?pageNum=0&address=" + address);
            request.addEventListener("load", callback);
            request.send()

        }

        var parseParams = function (tx) {
            // Parse the glitch params from a bitcoin transaction.
        }

		</script>
	</body>
</html>
